{% extends "base.html" %}
{% block title %}Edit Profile{% endblock %}

{% block content %}
<div class="container mb-5">

  {% if profile_form.errors or edu_formset.errors or work_formset.errors %}
    <div class="alert alert-danger">
      <strong>There are issues with your profile. Please fix them:</strong>
      <ul class="mb-0">
        {% for field, errors in profile_form.errors.items %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for form in edu_formset.forms %}
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        {% endfor %}
        {% for form in work_formset.forms %}
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <!-- Profile basics -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h4>ðŸ‘¤ Basic Info</h4>
        {{ profile_form.as_p }}
      </div>
    </div>

    <!-- Education -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h4>ðŸŽ“ Education</h4>
        {{ edu_formset.management_form }}
        <div id="edu-forms">
          {% for form in edu_formset %}
            <div class="border p-3 mb-3 edu-form">
              {{ form.as_p }}
            </div>
          {% endfor %}
        </div>
        <!-- hidden empty form -->
        <div id="empty-edu-form" class="d-none">
          <div class="border p-3 mb-3 edu-form">
            {{ edu_formset.empty_form.as_p }}
          </div>
        </div>
        <button type="button" id="add-edu" class="btn btn-outline-secondary btn-sm mt-2">
          + Add Another Education
        </button>
      </div>
    </div>

    <!-- Work -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h4>ðŸ’¼ Work Experience</h4>
        {{ work_formset.management_form }}
        <div id="work-forms">
          {% for form in work_formset %}
            <div class="border p-3 mb-3 work-form">
              {{ form.as_p }}
            </div>
          {% endfor %}
        </div>
        <!-- hidden empty form -->
        <div id="empty-work-form" class="d-none">
          <div class="border p-3 mb-3 work-form">
            {{ work_formset.empty_form.as_p }}
          </div>
        </div>
        <button type="button" id="add-work" class="btn btn-outline-secondary btn-sm mt-2">
          + Add Another Job
        </button>
      </div>
    </div>

    <!-- Save button -->
    <div class="mt-5">
      <button type="submit" class="btn btn-primary w-100">Save All Changes</button>
    </div>
  </form>
</div>

<script>
  function setupDynamicForm(prefix, addBtnId, formContainerId, emptyFormId) {
    const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const container = document.getElementById(formContainerId);
    const addBtn = document.getElementById(addBtnId);
    const emptyFormDiv = document.getElementById(emptyFormId).innerHTML;

    addBtn.addEventListener("click", () => {
      const formIndex = parseInt(totalFormsInput.value);
      let newFormHtml = emptyFormDiv.replace(/__prefix__/g, formIndex);
      container.insertAdjacentHTML("beforeend", newFormHtml);
      totalFormsInput.value = formIndex + 1;
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupDynamicForm("education", "add-edu", "edu-forms", "empty-edu-form");
    setupDynamicForm("work_experience", "add-work", "work-forms", "empty-work-form");
  });
</script>
{% endblock %}
